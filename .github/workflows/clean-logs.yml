name: Clean Logs (Manual)

on:
  workflow_dispatch:
    inputs:
      runs_older_than:
        description: "The amount of days old to delete"
        default: "7"
        required: false
      runs_to_keep:
        description: "The amount of latest workflows runs to keep"
        default: "5"
        required: false
      workflow_names:
        description: "Comma-separated workflow names to filter (empty = all)"
        default: ""
        required: false
      dry_run:
        description: "Dry run mode (preview only)"
        type: boolean
        default: true
        required: false
      test_mode:
        description: "Run all test scenarios"
        type: boolean
        default: false
        required: false

jobs:
  # Manual/Scheduled execution (actual cleanup)
  clean-logs:
    name: "Clean Logs (Manual)"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode != 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Clean workflow runs
        id: clean
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          runs_older_than: ${{ github.event.inputs.runs_older_than || '7' }}
          runs_to_keep: ${{ github.event.inputs.runs_to_keep || '5' }}
          workflow_names: ${{ github.event.inputs.workflow_names || '' }}
          dry_run: ${{ github.event.inputs.dry_run == 'true' }}

      - name: Display cleanup results
        run: |
          echo "=== Cleanup Results ==="
          echo "Total runs found: ${{ steps.clean.outputs.total-runs-found }}"
          echo "Runs deleted: ${{ steps.clean.outputs.runs-deleted }}"
          echo "Runs failed: ${{ steps.clean.outputs.runs-failed }}"
          echo ""
          echo "=== API Metrics ==="
          echo "Total API requests: ${{ steps.clean.outputs.total-api-requests }}"
          echo "Successful requests: ${{ steps.clean.outputs.successful-requests }}"
          echo "Failed requests: ${{ steps.clean.outputs.failed-requests }}"
          echo "Retry attempts: ${{ steps.clean.outputs.retry-attempts }}"
          echo "Rate limit hits: ${{ steps.clean.outputs.rate-limit-hits }}"
          echo "Circuit breaker trips: ${{ steps.clean.outputs.circuit-breaker-trips }}"

      - name: Check for failures
        if: steps.clean.outputs.runs-failed != '0'
        run: |
          echo "⚠️ Warning: ${{ steps.clean.outputs.runs-failed }} runs failed to delete"
          echo "Check the logs above for details"

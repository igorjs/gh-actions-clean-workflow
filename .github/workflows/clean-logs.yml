name: Clean Logs

on:
  workflow_dispatch:
    inputs:
      runs_older_than:
        description: "The amount of days old to delete"
        default: "7"
        required: false
      runs_to_keep:
        description: "The amount of latest workflows runs to keep"
        default: "5"
        required: false
      workflow_names:
        description: "Comma-separated workflow names to filter (empty = all)"
        default: ""
        required: false
      dry_run:
        description: "Dry run mode (preview only)"
        type: boolean
        default: true
        required: false
      test_mode:
        description: "Run all test scenarios"
        type: boolean
        default: false
        required: false

jobs:
  # Test 1: Basic dry run with default settings
  test-basic-dry-run:
    name: "Test: Basic Dry Run"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Run basic dry run
        id: basic
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          runs_older_than: 7
          runs_to_keep: 5

      - name: Display metrics
        run: |
          echo "=== Basic Dry Run Metrics ==="
          echo "Total runs found: ${{ steps.basic.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.basic.outputs.runs-deleted }}"
          echo "Runs failed: ${{ steps.basic.outputs.runs-failed }}"
          echo "API requests: ${{ steps.basic.outputs.total-api-requests }}"
          echo "Successful requests: ${{ steps.basic.outputs.successful-requests }}"
          echo "Failed requests: ${{ steps.basic.outputs.failed-requests }}"
          echo "Retry attempts: ${{ steps.basic.outputs.retry-attempts }}"
          echo "Rate limit hits: ${{ steps.basic.outputs.rate-limit-hits }}"
          echo "Circuit breaker trips: ${{ steps.basic.outputs.circuit-breaker-trips }}"

  # Test 2: Workflow filtering
  test-workflow-filtering:
    name: "Test: Workflow Filtering"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Test workflow name filtering
        id: filter
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          workflow_names: "Test and Lint, Check Dist"
          runs_older_than: 30
          runs_to_keep: 10

      - name: Display filtered metrics
        run: |
          echo "=== Workflow Filtering Metrics ==="
          echo "Filtered workflows: Test and Lint, Check Dist"
          echo "Total runs found: ${{ steps.filter.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.filter.outputs.runs-deleted }}"
          echo "API requests: ${{ steps.filter.outputs.total-api-requests }}"

  # Test 3: Keep all recent runs (runs_to_keep = 100)
  test-keep-many-runs:
    name: "Test: Keep Many Runs"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Test keeping many runs
        id: keep-many
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          runs_older_than: 7
          runs_to_keep: 100

      - name: Display keep-many metrics
        run: |
          echo "=== Keep Many Runs Metrics ==="
          echo "Runs to keep: 100 per workflow"
          echo "Total runs found: ${{ steps.keep-many.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.keep-many.outputs.runs-deleted }}"

  # Test 4: Delete all old runs (runs_to_keep = 0)
  test-delete-all-old:
    name: "Test: Delete All Old Runs"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Test deleting all old runs
        id: delete-all
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          runs_older_than: 90
          runs_to_keep: 0

      - name: Display delete-all metrics
        run: |
          echo "=== Delete All Old Runs Metrics ==="
          echo "Older than: 90 days"
          echo "Total runs found: ${{ steps.delete-all.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.delete-all.outputs.runs-deleted }}"

  # Test 5: Short retention period
  test-short-retention:
    name: "Test: Short Retention (1 day)"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Test short retention
        id: short
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          runs_older_than: 1
          runs_to_keep: 3

      - name: Display short retention metrics
        run: |
          echo "=== Short Retention Metrics ==="
          echo "Retention: 1 day"
          echo "Total runs found: ${{ steps.short.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.short.outputs.runs-deleted }}"

  # Test 6: Combined filtering and retention
  test-combined:
    name: "Test: Combined Features"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode == 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Test combined features
        id: combined
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          dry_run: true
          workflow_names: "Clean Logs, Dependabot"
          runs_older_than: 14
          runs_to_keep: 3

      - name: Display combined metrics
        run: |
          echo "=== Combined Features Metrics ==="
          echo "Workflows: Clean Logs, Dependabot"
          echo "Older than: 14 days"
          echo "Runs to keep: 3"
          echo "Total runs found: ${{ steps.combined.outputs.total-runs-found }}"
          echo "Runs to delete: ${{ steps.combined.outputs.runs-deleted }}"
          echo "Circuit breaker trips: ${{ steps.combined.outputs.circuit-breaker-trips }}"

  # Manual/Scheduled execution (actual cleanup)
  clean-logs:
    name: "Clean Logs (Manual/Scheduled)"
    runs-on: ubuntu-latest
    if: github.event.inputs.test_mode != 'true'
    permissions:
      actions: write
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: main

      - name: Clean workflow runs
        id: clean
        uses: igorjs/gh-actions-clean-workflow@main
        with:
          runs_older_than: ${{ github.event.inputs.runs_older_than || '7' }}
          runs_to_keep: ${{ github.event.inputs.runs_to_keep || '5' }}
          workflow_names: ${{ github.event.inputs.workflow_names || '' }}
          dry_run: ${{ github.event.inputs.dry_run == 'true' }}

      - name: Display cleanup results
        run: |
          echo "=== Cleanup Results ==="
          echo "Total runs found: ${{ steps.clean.outputs.total-runs-found }}"
          echo "Runs deleted: ${{ steps.clean.outputs.runs-deleted }}"
          echo "Runs failed: ${{ steps.clean.outputs.runs-failed }}"
          echo ""
          echo "=== API Metrics ==="
          echo "Total API requests: ${{ steps.clean.outputs.total-api-requests }}"
          echo "Successful requests: ${{ steps.clean.outputs.successful-requests }}"
          echo "Failed requests: ${{ steps.clean.outputs.failed-requests }}"
          echo "Retry attempts: ${{ steps.clean.outputs.retry-attempts }}"
          echo "Rate limit hits: ${{ steps.clean.outputs.rate-limit-hits }}"
          echo "Circuit breaker trips: ${{ steps.clean.outputs.circuit-breaker-trips }}"

      - name: Check for failures
        if: steps.clean.outputs.runs-failed != '0'
        run: |
          echo "⚠️ Warning: ${{ steps.clean.outputs.runs-failed }} runs failed to delete"
          echo "Check the logs above for details"
